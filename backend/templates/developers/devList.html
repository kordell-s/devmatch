{% extends 'base.html' %}

{% block title %}Developer List{% endblock %}

{% block content %}
<div class="" container mt-4">
    <div class="row">
        <div class="col-md-12 mb-5">
            <h1 class="text-center">Find your Developer of Need</h1>
        </div>
    </div>
</div>

<!-- Search Bar -->
<div class="row mb-4">
    <div class="col-md-8 mx-auto">
        <div class="input-group">
            <input type="text" id="search-input" class="form-control"
                placeholder="Search developers by name, bio, or skills..." value="{{ request.GET.search }}">
            <button class="btn btn-primary" type="button" id="search-btn">
                <i class="bi bi-search"></i> Search
            </button>
            <button class="btn btn-outline-secondary" type="button" id="clear-btn">Clear</button>
        </div>
    </div>
</div>

<!-- Skills Filter Row -->
<div class="row mb-4">
    <div class="col-12">
        <h5>Filter by Skills:</h5>
        <div class="d-flex flex-wrap gap-2" id="skills-filter">
            {% for skill in all_skills %}
            <button class="badge bg-secondary skill-filter text-decoration-none p-2 border-0" data-skill="{{ skill }}">
                {{ skill }}
            </button>
            {% endfor %}
        </div>
    </div>
</div>

<!--Loading Spinner-->
<div id="loading-spinner" class="text-center mb-4" style="display: none;">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>


<!-- Active Filters Display -->
<div id="active-filters" class="row mb-3 d-none">
    <div class="col-12">
        <div class="alert alert-info">
            <strong>Active Filters:</strong>
            <span id="filter-text"></span>
        </div>
    </div>
</div>

<!-- Developer Cards Container -->
<div id="developers-container" class="row">
    {% include 'developers/devTemplate.html' %}
</div>

<!-- No Results Message -->
<div id="no-results" class="col-12 d-none">
    <div class="alert alert-warning text-center">
        <h4>No developers found</h4>
        <p>Try adjusting your search criteria or filters.</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const clearBtn = document.getElementById('clear-btn');
        const skillFilters = document.querySelectorAll('.skill-filter');
        const developersContainer = document.getElementById('developers-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const activeFilters = document.getElementById('active-filters');
        const filterText = document.getElementById('filter-text');
        const noResults = document.getElementById('no-results');

        let currentSearch = '';
        let currentSkill = '';

        //search function
        function searchDevelopers() {
            const searchTerm = searchInput.value.trim();
            currentSearch = searchTerm;
            performSearch();
        }

        //Skill filter function
        function filterBySkill(skill) {
            //reset skill buttons
            skillFilters.forEach(btn => {
                btn.classList.remove('bg-primary');
                btn.classList.add('bg-secondary');
            });

            if (currentSkill === skill) {
                currentSkill = '';
            } else {
                currentSkill = skill;
                event.target.classList.remove('bg-secondary');
                event.target.classList.add('bg-primary');
            }
            performSearch();
        }

        //perform ajax search
        function performSearch() {
            showLoading();

            const params = new URLSearchParams();
            if (currentSearch) params.append('search', currentSearch);
            if (currentSkill) params.append('skill', currentSkill);

            fetch(`/api/developers/search/?${params}`)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    updateResults(data.developers);
                    updateActiveFilters();
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error fetching developers:', error);
                });
        }

        //update results
        function updateResults(developers) {
            if (developers.length === 0) {
                developersContainer.classList.add(`d-none`);
                noResults.classList.remove('d-none');
            } else {
                developersContainer.classList.remove('d-none');
                noResults.classList.add('d-none');
                developersContainer.innerHTML = '';
                developers.forEach(developer => {
                    developersContainer.innerHTML += createDeveloperCard(developer);
                });
            }
        }

        //create developer card html
        function createDeveloperCard(developer) {
            const profilePhoto = developer.profile_picture || '/static/images/default-profile.png';
            const skills = developer.skills.map(skill => `<span class="badge bg-primary me-2">${skill}</span>`).join('');

            return `
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <img src="${profilePhoto}" alt="${developer.username}" 
                         class="rounded-circle mb-3" 
                         style="width: 100px; height: 100px; object-fit: cover;">
                    <h5 class="card-title">${developer.first_name} ${developer.last_name}</h5>
                    ${developer.github_url ?
                    `<p><a href="${developer.github_url}" target="_blank" class="btn btn-outline-dark btn-sm">
                            <i class="bi bi-github"></i> GitHub
                        </a></p>` : ''
                }
                    <p class="card-text">${developer.bio || ''}</p>
                    <div>${skills}</div>
                    <a href="/developers/${developer.id}/" class="btn btn-outline-primary mt-3">View Profile</a>
                </div>
            </div>
        </div>`;
        }

        //update active filters display
        function updateActiveFilters() {
            let filters = [];
            if (currentSearch) filters.push(`Search: "${currentSearch}"`);
            if (currentSkill) filters.push(`Skill: "${currentSkill}"`);
            if (filters.length > 0) {
                filterText.textContent = filters.join(' | ');
                activeFilters.classList.remove('d-none');
            } else {
                activeFilters.classList.add('d-none');
            }
        }

        //show/hide loading

        function showLoading() {
            loadingSpinner.classList.remove('d-none');
            developersContainer.classList.add('d-none');
            noResults.classList.add('d-none');
        }

        function hideLoading() {
            loadingSpinner.classList.add('d-none');
            developersContainer.classList.remove('d-none');
        }

        //clear all filters

        function clearFilters() {
            currentSearch = '';
            currentSkill = '';
            searchInput.value = '';
            skillFilters.forEach(btn => {
                btn.classList.remove('bg-primary');
                btn.classList.add('bg-secondary');
            });
            performSearch();
        }

        //Event Listeners
        searchBtn.addEventListener('click', searchDevelopers);
        clearBtn.addEventListener('click', clearFilters);
        searchInput.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchDevelopers();
            }
        });
        // Debounced search on input
        let searchTimeout;
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(searchDevelopers, 500);
        });

        skillFilters.forEach(btn => {
            btn.addEventListener('click', function () {
                filterBySkill(this.dataset.skill);
            });
        });

        // Watchlist functionality
        function initializeWatchlistButtons() {
            // Check watchlist status for all visible developers
            const watchlistBtns = document.querySelectorAll('.watchlist-btn');
            watchlistBtns.forEach(btn => {
                const developerId = btn.dataset.developerId;
                checkWatchlistStatus(developerId, btn);
            });

            // Add event listeners
            document.addEventListener('click', function (e) {
                if (e.target.closest('.watchlist-btn')) {
                    const btn = e.target.closest('.watchlist-btn');
                    const developerId = btn.dataset.developerId;
                    const action = btn.dataset.action;

                    if (action === 'add') {
                        addToWatchlist(developerId, btn);
                    } else {
                        removeFromWatchlist(developerId, btn);
                    }
                }
            });
        }

        function checkWatchlistStatus(developerId, btn) {
            fetch(`/watchlist/check/${developerId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
                .then(response => response.json())
                .then(data => {
                    updateWatchlistButton(btn, data.is_in_watchlist);
                })
                .catch(error => console.error('Error checking watchlist status:', error));
        }

        function addToWatchlist(developerId, btn) {
            // Add loading animation
            const icon = btn.querySelector('.watchlist-icon');
            const text = btn.querySelector('.watchlist-text');

            icon.className = 'bi bi-hourglass-split';
            text.textContent = 'Saving...';
            btn.disabled = true;

            fetch(`/watchlist/add/${developerId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Success animation
                        icon.className = 'bi bi-check-circle-fill text-success';
                        text.textContent = 'Saved!';

                        setTimeout(() => {
                            updateWatchlistButton(btn, true);
                            showToast('Developer added to watchlist!', 'success');
                        }, 1000);
                    } else {
                        // Error state
                        icon.className = 'bi bi-exclamation-circle text-danger';
                        text.textContent = 'Error';
                        setTimeout(() => {
                            updateWatchlistButton(btn, false);
                            showToast(data.message || 'Failed to add to watchlist', 'error');
                        }, 1500);
                    }
                })
                .catch(error => {
                    console.error('Error adding to watchlist:', error);
                    icon.className = 'bi bi-exclamation-circle text-danger';
                    text.textContent = 'Error';
                    setTimeout(() => {
                        updateWatchlistButton(btn, false);
                        showToast('Failed to add to watchlist', 'error');
                    }, 1500);
                })
                .finally(() => {
                    btn.disabled = false;
                });
        }

        function removeFromWatchlist(developerId, btn) {
            const icon = btn.querySelector('.watchlist-icon');
            const text = btn.querySelector('.watchlist-text');

            icon.className = 'bi bi-hourglass-split';
            text.textContent = 'Removing...';
            btn.disabled = true;

            fetch(`/watchlist/remove/${developerId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateWatchlistButton(btn, false);
                        showToast('Developer removed from watchlist!', 'success');
                    } else {
                        updateWatchlistButton(btn, true);
                        showToast(data.message || 'Failed to remove from watchlist', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error removing from watchlist:', error);
                    updateWatchlistButton(btn, true);
                    showToast('Failed to remove from watchlist', 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                });
        }

        function updateWatchlistButton(btn, isInWatchlist) {
            const icon = btn.querySelector('.watchlist-icon');
            const text = btn.querySelector('.watchlist-text');

            if (isInWatchlist) {
                btn.className = 'btn btn-success watchlist-btn';
                btn.dataset.action = 'remove';
                icon.className = 'bi bi-bookmark-check-fill watchlist-icon';
                text.textContent = 'Saved';
            } else {
                btn.className = 'btn btn-outline-success watchlist-btn';
                btn.dataset.action = 'add';
                icon.className = 'bi bi-bookmark-plus watchlist-icon';
                text.textContent = 'Save';
            }
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        function showToast(message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} toast-notification`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize watchlist buttons when page loads
        initializeWatchlistButtons();

        // Re-initialize watchlist buttons after search results update
        const originalUpdateResults = updateResults;
        updateResults = function (developers) {
            originalUpdateResults(developers);
            setTimeout(initializeWatchlistButtons, 100);
        };
    });

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .watchlist-btn {
            transition: all 0.3s ease;
        }
        
        .watchlist-btn:disabled {
            opacity: 0.7;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}